---
title: "R-INLA manuscript"
author: "David Andryan"
date: "2025-08-02"
output: html_document
---

```{r}
setwd("D:/Documents/R/proyek")
```

```{r}
library(spdep)
library(SpatialEpi)
library(spdep)
library(raster)
library(sf)
library(sp)
library(ggpattern)
library(leaflet)
library(ggplot2)
library(viridis)
library(dplyr)
library(tidyr)
library(scales)
library(RColorBrewer)
library(ggrepel)
library(patchwork)
library(INLA)
```

```{r}
# Load file
file_path <- "D:/Documents/R/proyek/gadm41_IDN_3.json"
indo <- st_read(file_path)

# Convert the data to sf
indo_sf <- st_as_sf(indo)

# Subset the data for Kota Bandung
bdg_sf <- indo_sf[indo_sf$NAME_2 == "KotaBandung",]
```


```{r}
ma2 <- bdg_sf$geometry

ma2<-st_as_sf(ma2)
invalid_geometries <- st_is_valid(ma2, reason = TRUE)

ma2_valid <- st_make_valid(ma2)
ma2_simplified <- st_simplify(ma2_valid, dTolerance = 0.001)
ma2_sp <- as(ma2_simplified, "Spatial")
nb1 <- poly2nb(ma2_sp, queen = TRUE)
head(nb1)

nb1matriks <- nb2mat(nb1, style = "B", zero.policy = TRUE)
nb1list <- nb2listw(nb1)
```


```{r}
ma2 <- st_as_sf(ma2_sp)
ma2$ID <- 1:nrow(ma2)

ma2$NAME_3 <- bdg_sf$NAME_3

ggplot(ma2) + 
  geom_sf() + 
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                y = st_coordinates(st_centroid(geometry))[,2], 
                label = NAME_3), 
            size = 2.5, color = "red", fontface="bold", max.overlaps = 20,
            box.padding = 1, point.padding = 0.5) +
  labs(title = "Bandung Map") +
  theme_bw() +
  guides(fill = FALSE) +
  theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.title.y = element_blank())
```


Load Data
```{r}
dbd <- read.csv("data dbd 2016 sampai 2022.csv")
```


```{r}
pop_dbd <- dbd[, c("kecamatan", "N_2016", "N_2017", "N_2018", "N_2019", "N_2020", "N_2021", "N_2022")]
case_dbd <- dbd[,c("kecamatan", "y_2016", "y_2017", "y_2018", "y_2019", "y_2020", "y_2021", "y_2022")]

pop_dbd_long <- pop_dbd %>%
  pivot_longer(cols = starts_with("N_"), 
               names_to = "Year", 
               values_to = "Population") %>%
  mutate(Year = gsub("N_", "", Year))

ggplot(pop_dbd_long, aes(x = Year, y = Population, fill = Year)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Population in Bandung (2016-2022)",
       x = "Year",
       y = "Population") +
  theme_minimal() +
  theme(legend.position = "none")

case_dbd_long <- case_dbd %>% 
  pivot_longer(cols = starts_with("y_"),
               names_to = "Year",
               values_to = "Case") %>% 
  mutate(Year = gsub("y_", "", Year),  # Clean Year column
         Year = as.numeric(Year))

ggplot(case_dbd_long, aes(x = Year, y = Case, group = kecamatan, 
                          color = kecamatan)) +
  geom_line(size = 1) +  # Add lines for each sub-district
  scale_x_continuous(breaks = seq(2016, 2022, by = 1)) +
  scale_y_continuous(labels = scales::comma) +  # Format y-axis with commas
  labs(x = "Year",
       y = "Number of Case",
       color = "Sub-district") +  # Change legend title
  theme_minimal() +
  theme(legend.position = "right",
        legend.text = element_text(size = 7),   # Resize legend text
        legend.title = element_text(size = 12))  # Resize legend title

ggplot(case_dbd_long, aes(x = factor(Year), y = Case, fill=factor(Year))) +
  geom_boxplot() +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Year",
       y = "Number of Dengue Cases") +
  theme_minimal() +
  theme(legend.position = "none")
```

INLA
reference:
Blangiardo, M. dan Cameletti, M. (2015) Spatial and Spatio-Temporal Bayesian Models withR-INLA, 1st edition. John Wiley & Sons, United Kingdom.
Jaya, I. G. N. M. dan Andriyana, Y. (2020) Analisis Data Spasial Perspektif Bayesian, 1st edition. Cakrawala Baru Dunia Buku, Jatinangor
```{r}
control <- list(
  predictor = list(compute = TRUE,link=1),
  results = list(return.marginals.random = TRUE, 
                 return.marginals.predictor=TRUE),
  compute = list(hyperpar=TRUE, return.marginals=TRUE, dic=TRUE, 
                 mlik = TRUE, cpo = TRUE, 
                 po = TRUE, waic=TRUE, graph=TRUE, gdensity=TRUE,
                 openmp.strategy="huge"))
```

```{r}
E_2016 <- c(152.7367,116.5864,106.7823,107.8744,231.4512,92.77025,224.0884,
            48.38006,189.3169,189.454,135.0354,149.0958,111.3019,169.1744,
            110.0353,156.2031,91.35253,38.70685,206.3966,56.1448,206.6069,
            111.9967,98.73713,61.51344,118.0041,128.1914,169.6698,128.235,
            56.13545,118.0228)

E_2017 <- c(75.96977268,55.13641046,52.64538726,54.86399948,97.19637909,
          42.39601367,97.26501808,23.06341428,86.94629052,90.22165713,
          62.04678337,72.0359008,50.59408256,81.23852984,52.29647241,
          69.83873826,38.8067667,17.78321728,82.5476755,27.93964224,
          91.12039886,53.32462722,49.42221487,27.86242338,59.02452302,
          60.90709021,73.75187545,53.98027254,26.47462888,59.29979395)

E_2018 <- c(120.2070001,87.24257412,83.30106494,86.81140101,153.7933538,
          67.08353806,153.9028401,36.49282165,137.5758269,142.7578053,
          98.17766601,113.9832081,80.05597935,128.5448948,82.74911821,
          110.5056051,61.40379173,28.13799607,130.6161059,44.20878864,
          144.1811281,84.37561154,78.20148348,44.0868863,93.3952564,
          96.37396279,116.6989215,85.41291021,41.89151535,93.83094441)

E_2019 <- c(264.7958906,246.4046901,203.6521608,197.8823724,370.7356164,
          159.4705404,354.7618504,77.25105574,322.9478782,329.812858,
          228.7614251,269.8444554,186.3962196,301.5782916,194.4365265,
          256.4617518,143.2296545,67.04707811,304.9440015,107.168477,
          347.4694789,190.456441,189.5482336,1042.515285,222.8580768,
          214.0698343,270.6458149,205.5219996,98.99461015,230.3374321)

E_2020 <- c(107.4835082,88.50138018,86.21235887,77.4024183,159.0479005,
          66.97341387,1550.739362,29.98059624,128.9668106,133.087049,
          96.85351649,112.0727167,74.9235757,119.911219,80.49538856,
          103.0952868,58.84459672,28.31686855,123.0600191,46.50621353,
          141.4280194,73.95213739,79.7472694,44.54100499,93.41440154,
          88.36738869,112.4076955,83.6218567,38.12057935,97.92544842)

E_2021 <- c(184.6507788,153.0783658,150.0167985,131.0733507,272.4794912,
          115.1914703,265.5909647,51.08990459,220.8155427,228.469461,
          166.6640708,193.6441328,128.3944793,206.08175,138.918617,
          176.4228166,100.6490255,48.7937291,210.674101,81.13153388,
          242.2465139,126.4809998,138.727269,76.73053087,162.2630678,
          151.3562342,192.3046971,142.9369241,65.24965343,170.8737258)

E_2022 <- c(204.498938,165.4886454,164.1657174,151.5717643,294.6028018,
          126.1144472,281.2951109,59.79715096,250.4596289,255.9745097,
          181.034055,214.344498,145.7914937,233.8405969,156.037149,
          198.7930569,112.4649664,52.68591019,237.3188119,85.94206896,
          270.9931607,146.720358,151.4089115,83.56361325,178.0263037,
          166.3813203,212.0524951,160.2210597,78.0809009,185.3305553)
```


```{r}
nb2INLA("ma2_sp.adj", nb1)
G <- inla.read.graph(filename = "ma2_sp.adj")
ma2_sp$id <- dbd$kecamatan
```


```{r}
ma2_sp$y_2016 <- dbd$y_2016
ma2_sp$E_2016 <- E_2016


ma2_sp$re_u <- 1:nrow(ma2_sp@data)
ma2_sp$re_v <- 1:nrow(ma2_sp@data)

formula_2016 <- y_2016 ~ 1 + 
  f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2016 <- inla(formula_2016, family ="poisson", data = ma2_sp@data, E = E_2016,
                 control.predictor = list(compute = TRUE),
                 control.compute = control$compute,
                 control.inla = list(strategy = "simplified.laplace"))

summary(res_2016)
```

```{r}
res_2016$summary.random
res_2016$summary.fitted.values
inla.emarginal(exp,res_2016$marginals.fixed[[1]])
inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2016$marginals.fixed[[1]]))

csi <- res_2016$marginals.random$re_u[1:1:nrow(ma2_sp@data)]

zeta <- lapply(csi, function(x) inla.emarginal(exp,x))
zeta_ci <- lapply(csi, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})


zeta.cutoff <- c(0,0.5,1,1.5,2,3)

cat.zeta <- cut(unlist(zeta),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

maps.cat.zeta <- data.frame(ID = ma2_sp@data$id, cat.zeta=cat.zeta)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta

maps.cat.zeta
```


```{r}
ma2_sp$y_2017 <- dbd$y_2017
ma2_sp$E_2017 <- E_2017

formula_2017 <- y_2017 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2017 <- inla(formula_2017, family = "poisson", data = ma2_sp@data, E = E_2017,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.000001),
                               mean.intercept=0,      
                               prec.intercept=0.000001))

summary(res_2017)

res_2017$summary.random
res_2017$summary.fitted.values

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2017$marginals.fixed[[1]]))

csi.2017 <- res_2017$marginals.random$re_u[1:1:nrow(ma2_sp@data)]

zeta.2017 <- lapply(csi.2017, function(x) inla.emarginal(exp,x))
zeta_ci.17 <- lapply(csi.2017, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2017 <- cut(unlist(zeta.2017),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2017 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2017=cat.zeta.2017)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2017

cat.zeta.2017
```

```{r}
ma2_sp$y_2018 <- dbd$y_2018
ma2_sp$E_2018 <- E_2018


formula_2018 <- y_2018 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2018 <- inla(formula_2018, family = "poisson", data = ma2_sp@data, E = E_2018,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001))

summary(res_2018)

res_2018$summary.fitted.values

res_2018$summary.random

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2018$marginals.fixed[[1]]))

csi.2018 <- res_2018$marginals.random$re_u[1:1:nrow(ma2_sp@data)]

zeta.2018 <- lapply(csi.2018, function(x) inla.emarginal(exp,x))
zeta_ci.18 <- lapply(csi.2018, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2018 <- cut(unlist(zeta.2018),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2018 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2018=cat.zeta.2018)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2018

maps.cat.zeta.2018
```

```{r}
ma2_sp$y_2019 <- dbd$y_2019
ma2_sp$E_2019 <- E_2019


formula_2019 <- y_2019 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2019 <- inla(formula_2019, family = "poisson", data = ma2_sp@data, E = E_2019,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001))

summary(res_2019)

res_2019$summary.fitted.values

res_2019$summary.random

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2019$marginals.fixed[[1]]))

csi.2019 <- res_2019$marginals.random$re_u[1:1:nrow(ma2_sp@data)]
zeta_ci.19 <- lapply(csi.2019, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.2019 <- lapply(csi.2019, function(x) inla.emarginal(exp,x))

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2019 <- cut(unlist(zeta.2019),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2019 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2019=cat.zeta.2019)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2019

maps.cat.zeta.2019
```


```{r}
ma2_sp$y_2020 <- dbd$y_2020
ma2_sp$E_2020 <- E_2020


formula_2020 <- y_2020 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2020 <- inla(formula_2020, family = "poisson", data = ma2_sp@data, E = E_2020,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001))

summary(res_2020)

res_2020$summary.fitted.values

res_2020$summary.random

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2020$marginals.fixed[[1]]))

csi.2020 <- res_2020$marginals.random$re_u[1:1:nrow(ma2_sp@data)]
zeta_ci.20 <- lapply(csi.2020, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.2020 <- lapply(csi.2020, function(x) inla.emarginal(exp,x))

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2020 <- cut(unlist(zeta.2020),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2020 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2020=cat.zeta.2020)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2020

maps.cat.zeta.2020
```


```{r}
ma2_sp$y_2021 <- dbd$y_2021
ma2_sp$E_2021 <- E_2021


formula_2021 <- y_2021 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2021 <- inla(formula_2021, family = "poisson", data = ma2_sp@data, E = E_2021,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001))

summary(res_2021)

res_2021$summary.fitted.values

res_2021$summary.random

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2021$marginals.fixed[[1]]))

csi.2021 <- res_2021$marginals.random$re_u[1:1:nrow(ma2_sp@data)]

zeta.2021 <- lapply(csi.2021, function(x) inla.emarginal(exp,x))
zeta_ci.21 <- lapply(csi.2021, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2021 <- cut(unlist(zeta.2021),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2021 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2021=cat.zeta.2021)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2021

maps.cat.zeta.2021
```


```{r}
ma2_sp$y_2022 <- dbd$y_2022
ma2_sp$E_2022 <- E_2022


formula_2022 <- y_2022 ~ 1 + f(re_u, model = "bym", graph = G, scale.model = TRUE,
    hyper = list(prec.unstruct=list(prior = "loggamma", param = c(1,0.0005)),
                 prec.spatial = list(prior = "loggamma", param = c(1,0.0005))))
res_2022 <- inla(formula_2022, family = "poisson", data = ma2_sp@data, E = E_2022,
            control.predictor = list(compute = TRUE),
            control.compute = control$compute,
            control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "eb", 
                                strategy = "laplace"), 
            control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001))

summary(res_2022)

res_2022$summary.fitted.values

res_2022$summary.random

inla.qmarginal(c(0.025,0.975),inla.tmarginal(exp,res_2022$marginals.fixed[[1]]))

csi.2022 <- res_2022$marginals.random$re_u[1:1:nrow(ma2_sp@data)]
zeta_ci.22 <- lapply(csi.2022, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  c(lower = lower, median = median, upper = upper, mode = mode)
})

zeta.2022 <- lapply(csi.2022, function(x) inla.emarginal(exp,x))

zeta.cutoff <- c(0,0.5,1,1.5,2,3)

# Transform zeta in categorical variable
cat.zeta.2022 <- cut(unlist(zeta.2022),breaks=zeta.cutoff,
                include.lowest=TRUE, right = FALSE)

# Create a dataframe with all the information needed for the map
maps.cat.zeta.2022 <- data.frame(ID = ma2_sp@data$id, cat.zeta.2022=cat.zeta.2022)

data.boroughs <- attr(ma2, "data")

ma2_sp$ID <- ma2_sp$id

zeta.2022

maps.cat.zeta.2022
```

Morans' Index
```{r}
wb <- nb2mat(nb1, style = "B", zero.policy = TRUE)
wl <- nb2listw(nb1)

kasus.2016 <- ma2_sp@data$y_2016
moran.test(kasus.2016,wl)

kasus.2017 <- ma2_sp@data$y_2017
moran.test(kasus.2017, wl)

kasus.2018 <- ma2_sp@data$y_2018
moran.test(kasus.2018, wl)

kasus.2019 <- ma2_sp@data$y_2019
moran.test(kasus.2019, wl)

kasus.2020 <- ma2_sp@data$y_2020
moran.test(kasus.2020, wl)

kasus.2021 <- ma2_sp@data$y_2021
moran.test(kasus.2021, wl)

kasus.2022 <- ma2_sp@data$y_2022
moran.test(kasus.2022, wl)
```



Spatio-Temporal Model
```{r}
spasial.temporal.data <- read.csv("spatio temporal data dbd 2016 sampai 2022.csv")
```

Spatio-Temporal Moran's Index
```{r}
MoranST.MC <- function (x, W, nsim) 
{
    library(abind)
    library(spdep)
    if (!is.matrix(W)) 
        stop(paste(deparse(substitute(W)), "is not a numeric matrix"))
    if (!is.numeric(x)) 
        stop(paste(deparse(substitute(x)), "is not a numeric vector"))
    if (missing(nsim)) 
        stop("nsim must be given")
    xname <- deparse(substitute(x))
    wname <- deparse(substitute(W))
    MoranST <- function(x, W) {
        n <- nrow(W)
        T <- length(x)/n
        x <- matrix(x, n, T)
        if (n != nrow(x)) 
            stop("objects of different length")
        M <- 0
        w1 <- 0
        SS <- 0
        for (i in 1:n) {
            for (j in 1:T) {
                SS <- SS + (x[i, j] - mean(x))^2
                for (k in 1:n) {
                  for (h in 1:T) {
                    if (j == h) {
                      w <- W[i, k]
                    }
                    else if ((i == k) & (abs(j - h) == 1)) {
                      w <- 1
                    }
                    else w <- 0
                    M <- M + (w * (x[i, j] - mean(x)) * (x[k, 
                      h] - mean(x)))
                    w1 <- w1 + w
                  }
                }
            }
        }
        MoranST <- n * T * M/(w1 * SS)
        return(MoranST)
    }
    Moran <- MoranST(x, W)
    sim <- replicate(nsim, MoranST(sample(x), W))
    p.value <- mean((all <- c(Moran, sim) >= Moran))
    hist(sim, main = paste("Null Distribution of Moran's ST=", 
        round(Moran, 4)), sub = paste("p.valueST =", round(p.value, 
        4)), xlab = "Moran's I Simulation", xlim = range(all), 
        col = "blue")
    abline(v = Moran, col = "#903030", lty = 3, lwd = 2)
    Decision <- ifelse(p.value <= 0.05, paste("Reject H0"), paste("Accept H0"))
    Result <- list(MoranST = Moran, p.value = p.value, Simulation = sim)
    cat("****************************************************************************", 
        "\n*            MoranST with Monte Carlo Simulation                          										      *", 
        "\n****************************************************************************", 
        "\n", "Data input                               : ", 
        xname, "\n", "Weight input                             : ", 
        wname, "\n", "MoranST                                  : ", 
        Moran, "\n", "p.Value                                  : ", 
        p.value, "\n*********************************************************************", 
        "\n", "Decision with an alpha level of .05 (5%) :", Decision, 
        "[for H1:Rho > 0]", "\n************************************************************", 
        "\n")
    return(Result)
}

MoranST1<-MoranST.MC(spasial.temporal.data$case,wb, nsim = 100)
```


```{r}
E_st <- c(152.7367,116.5864,106.7823,107.8744,231.4512,92.77025,224.0884,
          48.38006,189.3169,189.454,135.0354,149.0958,111.3019,169.1744,
          110.0353,156.2031,91.35253,38.70685,206.3966,56.1448,206.6069,
          111.9967,98.73713,61.51344,118.0041,128.1914,169.6698,128.235,
          56.13545,118.0228,
          
          75.96977268,55.13641046,52.64538726,54.86399948,97.19637909,
          42.39601367,97.26501808,23.06341428,86.94629052,90.22165713,
          62.04678337,72.0359008,50.59408256,81.23852984,52.29647241,
          69.83873826,38.8067667,17.78321728,82.5476755,27.93964224,
          91.12039886,53.32462722,49.42221487,27.86242338,59.02452302,
          60.90709021,73.75187545,53.98027254,26.47462888,59.29979395,
          
          120.2070001,87.24257412,83.30106494,86.81140101,153.7933538,
          67.08353806,153.9028401,36.49282165,137.5758269,142.7578053,
          98.17766601,113.9832081,80.05597935,128.5448948,82.74911821,
          110.5056051,61.40379173,28.13799607,130.6161059,44.20878864,
          144.1811281,84.37561154,78.20148348,44.0868863,93.3952564,
          96.37396279,116.6989215,85.41291021,41.89151535,93.83094441,
          
          264.7958906,246.4046901,203.6521608,197.8823724,370.7356164,
          159.4705404,354.7618504,77.25105574,322.9478782,329.812858,
          228.7614251,269.8444554,186.3962196,301.5782916,194.4365265,
          256.4617518,143.2296545,67.04707811,304.9440015,107.168477,
          347.4694789,190.456441,189.5482336,1042.515285,222.8580768,
          214.0698343,270.6458149,205.5219996,98.99461015,230.3374321,
          
          107.4835082,88.50138018,86.21235887,77.4024183,159.0479005,
          66.97341387,1550.739362,29.98059624,128.9668106,133.087049,
          96.85351649,112.0727167,74.9235757,119.911219,80.49538856,
          103.0952868,58.84459672,28.31686855,123.0600191,46.50621353,
          141.4280194,73.95213739,79.7472694,44.54100499,93.41440154,
          88.36738869,112.4076955,83.6218567,38.12057935,97.92544842,
          
          184.6507788,153.0783658,150.0167985,131.0733507,272.4794912,
          115.1914703,265.5909647,51.08990459,220.8155427,228.469461,
          166.6640708,193.6441328,128.3944793,206.08175,138.918617,
          176.4228166,100.6490255,48.7937291,210.674101,81.13153388,
          242.2465139,126.4809998,138.727269,76.73053087,162.2630678,
          151.3562342,192.3046971,142.9369241,65.24965343,170.8737258,
          
          204.498938,165.4886454,164.1657174,151.5717643,294.6028018,
          126.1144472,281.2951109,59.79715096,250.4596289,255.9745097,
          181.034055,214.344498,145.7914937,233.8405969,156.037149,
          198.7930569,112.4649664,52.68591019,237.3188119,85.94206896,
          270.9931607,146.720358,151.4089115,83.56361325,178.0263037,
          166.3813203,212.0524951,160.2210597,78.0809009,185.3305553)
```


```{r}
spasial.temporal.data$IS1 <- spasial.temporal.data$IS0
spasial.temporal.data$IT2 <- spasial.temporal.data$IT0
```

Separable
```{r}
formula.separable <- case ~ 1 + 
  f(IS0, model = "bym", graph = G,
    hyper = list(prec.unstruct = list(
      prior = "loggamma",
      param = c(1,0.0005)),
      prec.spatial = list(prior = "loggamma",
                          param = c(1,0.0005)))) +
  f(IT0, model = "rw1", hyper = list(prec = list(prior = "loggamma", 
                                                 param = c(1,0.0005)))) +
  f(IT1, model = "iid", hyper = list(prec = list(prior = "loggamma", 
                                                 param = c(1,0.0005))))

lcs <- inla.make.lincombs(IT0 = diag(7), IT1 = diag(7))

res.separable <- inla(formula.separable, family = "poisson",
                      data = spasial.temporal.data,
                      E = E_st,
                      control.predictor = list(compute=TRUE),
                      control.compute = list(dic=TRUE, cpo=TRUE),
                      control.inla = list(tolerance=1e-20, 
                                h=1e-8,int.strategy = "grid", 
                                strategy = "laplace"),
                      control.fixed=list(mean=list(0), prec=list(0.0001),
                               mean.intercept=0,      
                               prec.intercept=0.0001),
                      lincomb = lcs)
summary(res.separable)
```

```{r}
temporal.separable <- lapply(res.separable$marginals.random$IT0,
                             function(X){
                               marg <- inla.tmarginal(function(x) exp(x), X)
                               inla.emarginal(mean, marg)
                               })
temporal.separable.iid <- lapply(res.separable$marginals.random$IT1,
                                 function(X){
                                   marg <- inla.tmarginal(function(x) exp(x), X)
                                   inla.emarginal(mean, marg)
                                   })

plot(seq(1,7),seq(0.5,2.5,length=7),type="n",xlab="t",ylab="")
lines(unlist(temporal.separable.iid))
lines(unlist(temporal.separable),lty=2)
abline(h=1,lty=1)

res.separable$summary.fitted.values
res.separable$summary.random
temporal.IT0 <- res.separable$marginals.random$IT0
temporal.IT1 <- res.separable$marginals.random$IT1

csi.separable <- res.separable$marginals.random$IS0
zeta.separable <- unlist(lapply(csi.separable, function(x) inla.emarginal(exp,x)))
zeta.separable.IT0 <- unlist(lapply(temporal.IT0, function(x) inla.emarginal(exp, x)))
zeta.separable.IT1 <- unlist(lapply(temporal.IT1, function(x) inla.emarginal(exp, x)))

zeta.separable.CI <- lapply(csi.separable, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

zeta.separable.IT0.CI <- lapply(temporal.IT0, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

zeta.separable.IT1.CI <- lapply(temporal.IT1, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

# Matriks untuk menyimpan hasil RR mean
RR_total <- matrix(NA, nrow = 30, ncol = 7)  # 30 kecamatan, 7 tahun

# Array untuk menyimpan CI, median, dan modus dari RR total
RR_total_CI <- array(NA, dim = c(30, 7, 4))  # 30 kecamatan, 7 tahun, 4 untuk lower, upper CI, median, dan modus

# Perhitungan untuk setiap kecamatan dan tahun
for (i in 1:30) {
  for (j in 1:7) {
    # Mengambil nilai ekspektasi dari posterior marginal untuk setiap komponen
    zeta_spatial <- zeta.separable[i]
    zeta_temporal_IT0 <- zeta.separable.IT0[j]
    zeta_temporal_IT1 <- zeta.separable.IT1[j]

    # Menghitung nilai RR mean
    RR_mean <- exp(log(zeta_spatial) + log(zeta_temporal_IT0) + log(zeta_temporal_IT1))
    
    # Menghitung CI lower dan upper, median, dan modus untuk RR
    RR_lower <- exp(log(zeta.separable.CI[[i]]["lower"]) + log(zeta.separable.IT0.CI[[j]]["lower"]) +
                    log(zeta.separable.IT1.CI[[j]]["lower"]))
    RR_upper <- exp(log(zeta.separable.CI[[i]]["upper"]) + log(zeta.separable.IT0.CI[[j]]["upper"]) +
                    log(zeta.separable.IT1.CI[[j]]["upper"]))
    RR_median <- exp(log(zeta.separable.CI[[i]]["median"]) + log(zeta.separable.IT0.CI[[j]]["median"]) +
                     log(zeta.separable.IT1.CI[[j]]["median"]))
    RR_mode <- exp(log(zeta.separable.CI[[i]]["mode"]) + log(zeta.separable.IT0.CI[[j]]["mode"]) +
                   log(zeta.separable.IT1.CI[[j]]["mode"]))

    # Menyimpan hasil mean RR
    RR_total[i, j] <- RR_mean

    # Menyimpan CI, median, dan modus dalam array
    RR_total_CI[i, j, 1] <- RR_lower
    RR_total_CI[i, j, 2] <- RR_upper
    RR_total_CI[i, j, 3] <- RR_median
    RR_total_CI[i, j, 4] <- RR_mode
  }
}

# Hasil
RR_total        # Mean dari Relative Risk total
RR_total_CI     # CI, median, dan modus dari Relative Risk total
```

Inseparable
```{r}
spasial.temporal.data
```

```{r}
variable.int <- interaction(spasial.temporal.data$IS1, spasial.temporal.data$IT2)

formula_st <- case ~ 1 + 
  f(IS0, model = "bym", graph = G,
                           hyper = list(prec.unstruct=list(
                             prior = "loggamma", 
                             param = c(1,0.0005)),
                             prec.spatial = list(prior = "loggamma", 
                                                 param = c(1,0.0005)))) + 
  f(IT0, model = "rw1", hyper = list(prec = list(prior = "loggamma", 
                                                 param = c(1,0.0005)))) + 
  f(IT1, model = "iid", hyper = list(prec = list(prior = "loggamma", 
                                                 param = c(1,0.0005)))) +
  f(variable.int, model = "iid", hyper = list(prec = list(prior = "loggamma", 
                                                 param = c(1,0.0005))))

lcs <- inla.make.lincombs(IT0 = diag(7), IT1 = diag(7))

res.inseparable <- inla(formula_st, family = "poisson", 
                        data = spasial.temporal.data,
                        E=E_st, control.predictor = list(compute=TRUE),
                        control.compute = list(dic=TRUE, cpo=TRUE),
                        control.inla = list(tolerance=1e-20,
                                            h=1e-8,int.strategy = "grid",
                                            strategy = "laplace"),
                        control.fixed=list(mean=list(0), prec=list(0.0001),
                                           mean.intercept=0,
                                           prec.intercept=0.0001),
                      lincomb = lcs)
summary(res.inseparable)
```

```{r}
temporal.inseparable <- lapply(res.inseparable$marginals.random$IT0,
                             function(X){
                               marg <- inla.tmarginal(function(x) exp(x), X)
                               inla.emarginal(mean, marg)
                               })
temporal.inseparable.iid <- lapply(res.inseparable$marginals.random$IT1,
                                 function(X){
                                   marg <- inla.tmarginal(function(x) exp(x), X)
                                   inla.emarginal(mean, marg)
                                   })

plot(seq(1,7),seq(0.5,2.5,length=7),type="n",xlab="t",ylab="")
lines(unlist(temporal.inseparable.iid))
lines(unlist(temporal.inseparable),lty=2)
abline(h=1,lty=1)


res.inseparable$summary.fitted.values
res.inseparable$summary.random
temporal.inseparable.IT0 <- res.inseparable$marginals.random$IT0
temporal.inseparable.IT1 <- res.inseparable$marginals.random$IT1
int.variable <- res.inseparable$marginals.random$variable.int

csi.inseparable <- res.inseparable$marginals.random$IS0
zeta.inseparable <- unlist(lapply(csi.inseparable, 
                                  function(x) inla.emarginal(exp,x)))
zeta.inseparable.IT0 <- unlist(lapply(temporal.IT0, 
                                      function(x) inla.emarginal(exp, x)))
zeta.inseparable.IT1 <- unlist(lapply(temporal.IT1, 
                                      function(x) inla.emarginal(exp, x)))
zeta.inseparable.int <- unlist(lapply(int.variable,
                                      function(x) inla.emarginal(exp,x)))

zeta.inseparable.CI <- lapply(csi.inseparable, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

zeta.inseparable.IT0.CI <- lapply(temporal.IT0, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

zeta.inseparable.IT1.CI <- lapply(temporal.IT1, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

zeta.inseparable.int.CI <- lapply(int.variable, function(x) {
  lower <- inla.qmarginal(0.025, inla.tmarginal(exp, x))
  median <- inla.qmarginal(0.5, inla.tmarginal(exp, x))
  upper <- inla.qmarginal(0.975, inla.tmarginal(exp, x))
  mode <- inla.mmarginal(inla.tmarginal(exp, x))
  return(c(lower = lower, median = median, upper = upper, mode = mode))
})

# Matriks untuk menyimpan hasil RR mean
RR_total.inseparable <- matrix(NA, nrow = 30, ncol = 7)  # 30 kecamatan, 7 tahun

# Array untuk menyimpan CI, median, dan modus dari RR total
RR_total_inseparable_CI <- array(NA, dim = c(30, 7, 4))  # 30 kecamatan, 7 tahun, 4 kolom untuk lower, upper CI, median, dan modus

# Perhitungan untuk setiap kecamatan dan tahun
for (i in 1:30) {
  for (j in 1:7) {
    # Mengambil nilai ekspektasi dari posterior marginal untuk setiap komponen
    zeta_spatial <- zeta.inseparable[i]
    zeta_temporal_IT0 <- zeta.inseparable.IT0[j]
    zeta_temporal_IT1 <- zeta.inseparable.IT1[j]
    zeta_interaction <- zeta.inseparable.int[i]

    # Menghitung nilai RR mean
    RR_mean <- exp(log(zeta_spatial) + log(zeta_temporal_IT0) + log(zeta_temporal_IT1) +
                     log(zeta_interaction))
    
    # Menghitung CI lower dan upper, median, dan modus untuk RR
    RR_lower <- exp(log(zeta.inseparable.CI[[i]]["lower"]) + log(zeta.inseparable.IT0.CI[[j]]["lower"]) +
                    log(zeta.inseparable.IT1.CI[[j]]["lower"]) + log(zeta.inseparable.int.CI[[i]]["lower"]))
    RR_upper <- exp(log(zeta.inseparable.CI[[i]]["upper"]) + log(zeta.inseparable.IT0.CI[[j]]["upper"]) +
                    log(zeta.inseparable.IT1.CI[[j]]["upper"]) + log(zeta.inseparable.int.CI[[i]]["upper"]))
    RR_median <- exp(log(zeta.inseparable.CI[[i]]["median"]) + log(zeta.inseparable.IT0.CI[[j]]["median"]) +
                     log(zeta.inseparable.IT1.CI[[j]]["median"]) + log(zeta.inseparable.int.CI[[i]]["median"]))
    RR_mode <- exp(log(zeta.inseparable.CI[[i]]["mode"]) + log(zeta.inseparable.IT0.CI[[j]]["mode"]) +
                   log(zeta.inseparable.IT1.CI[[j]]["mode"]) + log(zeta.inseparable.int.CI[[i]]["mode"]))

    # Menyimpan hasil mean RR
    RR_total.inseparable[i, j] <- RR_mean

    # Menyimpan CI, median, dan modus dalam array
    RR_total_inseparable_CI[i, j, 1] <- RR_lower
    RR_total_inseparable_CI[i, j, 2] <- RR_upper
    RR_total_inseparable_CI[i, j, 3] <- RR_median
    RR_total_inseparable_CI[i, j, 4] <- RR_mode
  }
}

# Hasil
RR_total.inseparable        # Mean dari Relative Risk total
RR_total_inseparable_CI     # CI, median, dan modus dari Relative Risk total
```


INLA Mapping
```{r}
ma2$ID <- ma2_sp@data$id

ma2 <- ma2 %>%
  left_join(maps.cat.zeta, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2017, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2018, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2019, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2020, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2021, by = "ID")
ma2 <- ma2 %>%
  left_join(maps.cat.zeta.2022, by = "ID")
```

```{r}
RR_df <- data.frame(ID = ma2_sp@data$id, RR_total)
ma2 <- ma2 %>%
  left_join(RR_df, by = "ID")

rr_cutoff <- c(0, 0.5, 1, 1.5, 2, 3)

# Terapkan cut-off untuk data RR 1 (misalnya RR_total[, 1])
cat.rr1.sep <- cut(RR_total[, 1], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr2.sep <- cut(RR_total[, 2], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr3.sep <- cut(RR_total[, 3], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr4.sep <- cut(RR_total[, 4], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr5.sep <- cut(RR_total[, 5], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr6.sep <- cut(RR_total[, 6], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))
cat.rr7.sep <- cut(RR_total[, 7], breaks = rr_cutoff, include.lowest = TRUE, right = FALSE,
                   levels = c("[0,0.5)", "[0.5,1)", "[1,1.5)", "[1.5,2)", "[2,3)"))

ma2 <- ma2 %>%
  mutate(cat_rr1_sep = cat.rr1.sep,
         cat_rr2_sep = cat.rr2.sep,
         cat_rr3_sep = cat.rr3.sep,
         cat_rr4_sep = cat.rr4.sep,
         cat.rr5.sep = cat.rr5.sep,
         cat_rr6_sep = cat.rr6.sep,
         cat_rr7_sep = cat.rr7.sep)
```

INLA INSEPARABLE MODEL
```{r}
RR.df.ins <- data.frame(ID = ma2_sp@data$id, RR_total.inseparable)
ma2 <- ma2 %>%
  left_join(RR.df.ins, by = "ID")

rr_cutoff <- c(0, 0.5, 1, 1.5, 2, 3)

# Terapkan cut-off untuk data RR 1 (misalnya RR_total[, 1])
cat.rr1.ins <- cut(RR_total.inseparable[, 1], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr2.ins <- cut(RR_total.inseparable[, 2], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr3.ins <- cut(RR_total.inseparable[, 3], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr4.ins <- cut(RR_total.inseparable[, 4], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr5.ins <- cut(RR_total.inseparable[, 5], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr6.ins <- cut(RR_total.inseparable[, 6], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)
cat.rr7.ins <- cut(RR_total.inseparable[, 7], 
                   breaks = rr_cutoff, include.lowest = TRUE, right = FALSE)

ma2 <- ma2 %>%
  mutate(cat.rr1.ins = cat.rr1.ins,
         cat.rr2.ins = cat.rr2.ins,
         cat.rr3.ins = cat.rr3.ins,
         cat.rr4.ins = cat.rr4.ins,
         cat.rr5.ins = cat.rr5.ins,
         cat.rr6.ins = cat.rr6.ins,
         cat.rr7.ins = cat.rr7.ins)
```

```{r}
ggplot(ma2) + 
  geom_sf(aes(fill = cat.zeta.2017), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() + 
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14)) +
  labs(fill = "Relative Risk")

ggplot(ma2) + 
  geom_sf(aes(fill = cat.zeta.2020), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = NAME_3), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() + 
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14)) +
  labs(fill = "Relative Risk")

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr1.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  theme_minimal() +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr2.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))


ggplot(ma2) +
  geom_sf(aes(fill = cat.rr3.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr4.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr5.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr6.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID),
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))

ggplot(ma2) +
  geom_sf(aes(fill = cat.rr7.ins), color = "black", size = 0.3) +
  scale_fill_viridis(option = "C", discrete = TRUE, name = "Relative Risk") +
  geom_text_repel(aes(x = st_coordinates(st_centroid(geometry))[,1], 
                      y = st_coordinates(st_centroid(geometry))[,2], 
                      label = ID), 
                  size = 5, color = "black", fontface="bold", max.overlaps = 20,
                  box.padding = 1, point.padding = 0.5) +
  theme_minimal() +
  labs(fill = "Relative Risk") +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 24, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "italic"),
        legend.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14))
```



